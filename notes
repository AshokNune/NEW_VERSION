import pandas as pd
import os
import glob
from concurrent.futures import ProcessPoolExecutor

def process_file(file, label_col, selected_cols):
    try:
        df = pd.read_excel(file)

        if label_col not in df.columns:
            return None

        filtered = df[
            df[label_col].notna() &
            (df[label_col].astype(str).str.strip() != "") &
            (df[label_col].astype(str).str.strip().str.lower() != "lfp")
        ]

        if filtered.empty:
            return None

        # Add source filename
        filtered["SourceFile"] = os.path.basename(file)

        if selected_cols:
            existing_cols = [col for col in selected_cols if col in filtered.columns]
            if "SourceFile" not in existing_cols:
                existing_cols.append("SourceFile")
            filtered = filtered[existing_cols]

        return filtered

    except Exception as e:
        print(f"‚ùå Error reading {file}: {e}")
        return None

def merge_filtered_from_folder(input_folder, output_file, label_col="Classification", selected_cols=None, workers=4):
    all_data = []

    xlsx_files = glob.glob(os.path.join(input_folder, "*.xlsx"))

    if not xlsx_files:
        print(f"No .xlsx files found in {input_folder}")
        return

    with ProcessPoolExecutor(max_workers=workers) as executor:
        results = executor.map(lambda f: process_file(f, label_col, selected_cols), xlsx_files)

        for result in results:
            if result is not None:
                all_data.append(result)

    if all_data:
        merged_df = pd.concat(all_data, ignore_index=True)
        merged_df.to_excel(output_file, index=False)
        print(f"\nüíæ Merged filtered data saved to: {output_file}")
    else:
        print("\n‚ö† No matching rows found in given folder.")

if __name__ == "__main__":
    folder_path = input("Enter folder path containing .xlsx files: ").strip()
    output_file = input("Enter output Excel filename (default merged_filtered.xlsx): ").strip() or "merged_filtered.xlsx"

    selected_columns = [
        "Snippet",
        "Classification",
        "FileName"
    ]

    merge_filtered_from_folder(folder_path, output_file, label_col="Classification", selected_cols=selected_columns, workers=4)
